GJ.add("app/ms_v2/widget/key_search_with_local_storage_v2.js",["jquery","js/util/storage/storage2.js","app/common/widget/widget.js","js/util/autocomplete/autocomplete2.js","log_tracker"],function(c,d,b){var f=c("jquery");var j=c("app/common/widget/widget.js");var k=c("js/util/autocomplete/autocomplete2.js");var m=c("js/util/storage/storage2.js");var h=new m("SearchHistory");var i=h.get("history")||[];var a=15;var l=false;var e=false;var g="";b.exports=j.define({events:{"click [data-role=btn]":function(){this.search()},"focus [data-role=input]":function(){this.config.$input.addClass(this.focusClass);this.config.$el.addClass("s-search-focus");this.config.$el.addClass("input_current")},"blur [data-role=input]":"checkInput","mouseenter [data-role=selected]":"showSelect","mouseleave [data-role=selected]":"hideSelect","click [data-role=option]":"selectCat"},init:function(o){var n=this;n.config=o;n.focusClass="focus";if(o.focusClass){n.focusClass=o.focusClass}if(o.autocompleteUrl){n.initAutocomplete()}var p=n.config.$input;p.keydown(function(q){if(q.keyCode===13){l=true}}).keypress(function(q){if(q.keyCode===13&&l&&(!n.autocomplete||n.autocomplete.active<0)){q.preventDefault();n.search()}l=false});if(this.config.$selected&&this.config.$selected.length){g=this.config.$selected.data("cate")}},showSelect:function(p){var o=this;p.preventDefault();var n=f(p.currentTarget);o.config.$el.addClass("search_current");n.addClass("active");GJ.LogTracker.trackEvent("/search/list_top_box/hover_cate@isNew=true")},hideSelect:function(p){var o=this;p.preventDefault();var n=f(p.currentTarget);o.config.$el.removeClass("search_current");n.removeClass("active")},selectCat:function(r){r.preventDefault();var p=this.config.$selected;var o=this.config.$options;var n=f(r.currentTarget);var q=n.data();q.text=n.find("a").text();GJ.LogTracker.trackEvent("/search/list_top_box/click_cate@isNew=true");p.data("is-sub-cate",q.isSubCate||false).data("default-url",q.defaultUrl).data("cate",q.cate).data("target",q.target||"_self").find(".js-text").text(q.text);p.removeClass("active");o.find(":hidden").show();n.hide();e=true},checkInput:function(){this.config.$el.removeClass("s-search-focus");var n=this.config.$input;this.config.$el.removeClass("input_current");if(!n.val()){n.removeClass(this.focusClass)}else{n.addClass(this.focusClass)}},search:function(t,v){var q=this.config;var w=q.$input;var p=f.trim(w.val());p=p.replace(/<|>|\//g,"");var n="";t=t||{};if(!p||(p===this.lastValue&&!this.config.target)){return false}if(!v){v=[]}this.lastValue=p;if(q.isList===1){n=q.$selected.data("default-url")||q.urlTemplate;n=n.replace("{{cate}}",q.$selected.data("cate")).replace("{{keyword}}",encodeURIComponent(p))}else{if(t.url){n=t.url}else{if(p){n=q.urlTemplate.replace("{{keyword}}",encodeURIComponent(p))}else{if(q.defaultUrl){n=q.defaultUrl}}}}if(!q.disableHistory){GJ.each(i,function(y,x){if(y.text===p){i.splice(x,1);return false}});i.unshift({text:p,_source:"localStorage",_originKeyword:p,url:t.url,cat:t.cat});i.splice(10,i.length-10);h.set("history",i)}var u=f.Deferred();var r=f.Deferred();var s=f.Deferred();var o=false;if(q.isList===1){o=true}GJ.LogTracker.trackEvent("/search/list_top_box@atype=click",function(){u.resolve()});GJ.LogTracker.trackEvent("/search@isList="+o+"@isHeaderFixed="+f("body").hasClass("header-fixed")+"@kw="+p,function(){r.resolve()});if(e){GJ.LogTracker.trackEvent("/search/list_top_box/change_cate_v5@from="+g+"@to="+q.$selected.data("cate")+"@atype=click",function(){s.resolve()})}else{s.resolve()}v=v.concat([r,s,u]);this.go(n,v)},go:function(o,r){var n=f.trim(f(this.config.$input).val());var q;if(n){try{q=GJ.jsonDecode(GJ.getCookie("_gl_tracker"))||{}}catch(p){q={}}q.kw=n;GJ.setCookie("_gl_tracker",GJ.jsonEncode(q),0)}if(this.config.target&&this.config.target==="_blank"){window.open(o,"_blank")}else{if(r&&r.length){var s=setTimeout(function(){window.location.href=o},2000);f.when.apply(f,r).done(function(){clearTimeout(s);window.location.href=o})}else{window.location.href=o}}},initAutocomplete:function(){var n=this;var o=this.config;var p=o.$el;var t=o.$input;var r="";var q=o.width||t.outerWidth();if(o.homePage-0===1){q-=1}var s=0;if(o.left!==undefined){s=o.left}this.autocomplete=new k({$input:t,$container:o.$el,overClass:"search-hover",left:o.$selected.width(),top:1,width:t.outerWidth(),noCache:true,defaultDataHandler:function(u){if(!o.disableHistory){u(i)}},getDataHandler:function(u,z){var w=[],y={};var v=o.autocompleteUrl.replace("{{keyword}}",encodeURIComponent(u));if(o.$selected&&o.$selected.length){var x=o.$selected.data("cate");if(x!=="site"){v+="&cate="+x}}if(!o.disableHistory){GJ.each(i,function(A){if(A.text&&(A.text.indexOf(u)===0||A._originKeyword.indexOf(u)===0)){w.push(A);y[A.text]=A;if(w.length>=2){return false}}})}f.getJSON(v,function(A){GJ.each(A,function(B){if(y[B.text]&&y[B.text].url===B.url){return}if(w.length>=10){return false}w.push(B)});z(w)})},formatItem:function(x,u,z){var y=x.text.length>a?x.text.substr(0,a)+"...":x.text;var w=new RegExp("^("+u+")","g");y=y.replace(w,'<b style="font-weight:normal">$1</b>');var v='<span class="fl">'+y+"</span>";if(x._source==="localStorage"){v='<span class="fl"><em>'+y+"</em></span>"}if(x.cat&&o.isList!==1){if(x.cat.length>1){v+='<span class="fl">在 '+x.cat[0]+" > "+x.cat[1]+" 分类中搜索</span>"}else{v+='<span class="fl">在 '+x.cat[0]+" > 分类中搜索</span>"}}if(x._source==="localStorage"){v+='<a href="###" class="js-del fr" style="width:24px; height:42px; display:block;"></a>';z.addClass("js-storage")}if(x.count){v+='<span class="fr" style="color:#999;">约'+x.count+"条</span>"}return v}});this.autocomplete.on("showResult",function(u){var y=this.$input;var x=this;var w=u.find("li").length;var v=u.find("li.js-storage").length;if(v&&w>v){u.find("li:eq("+(v-1)+")").addClass("st2")}u.find(".js-del").on("mousedown",function(A){A.preventDefault();A.stopPropagation();var B=f(A.target).parents("li");var z=B.data("data");if(!o.disableHistory){GJ.each(i,function(D,C){if(D.text===z.text){i.splice(C,1);return false}});h.set("history",i)}x.hasFocus=true;setTimeout(function(){y.trigger("focus");x.$resultEl.show();B.remove()},0)});f(window).one("scrollEvent",function(){x.hideResults()})});this.autocomplete.on("itemSelect",function(w,A){var u=false;var v="",y=t.val();var z=f("body").hasClass("header-fixed");var x=[];A.closest("ul").find(">li").each(function(){var B=f(this).data("data");if(B._source==="localStorage"){u=true}});t.val(w.text);if(w.cat){GJ.LogTracker.trackEvent("/search/suggest@suggest=yitu@isHeaderFixed="+z+"@atype=click")}if(u){(function(B){x.push(B);if(w._source==="localStorage"){if(!y){v="/search/suggest@suggest=history@input=false@kw="+w.text+"@isHeaderFixed="+z+"@atype=click"}else{v="/search/suggest@suggest=history@input=true@kw="+w.text+"@isHeaderFixed="+z+"@atype=click"}}else{v="/search/suggest@suggest=remote@kw="+w.text+"@isHeaderFixed="+z+"@atype=click"}GJ.LogTracker.trackEvent(v,function(){B.resolve()})})(f.Deferred())}if(typeof w.idx!=="undefined"){(function(B){x.push(B);v="/search/suggest@kw="+encodeURIComponent(w.text)+"@src_kw="+encodeURIComponent(r)+"@no="+w.idx+"@isHeaderFixed="+z;GJ.LogTracker.trackEvent(v,function(){B.resolve()})})(f.Deferred())}n.search(w,x)})}})});